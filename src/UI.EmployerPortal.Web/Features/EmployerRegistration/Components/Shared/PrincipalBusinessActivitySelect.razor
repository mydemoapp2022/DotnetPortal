@using System.Linq.Expressions
@using UI.EmployerPortal.Web.Features.EmployerRegistration.Models
@using Microsoft.AspNetCore.Components.Forms

<div class="form-group">
    <label for="@Id" class="form-label">
        @if (IsRequired)
        {
            <span class="required-indicator">*</span>
        }
        @Label
    </label>
    <InputSelect id="@Id"
                 class="@($"form-control {CssClass}")"
                 @bind-Value="Value"
                 @bind-Value:after="OnValueChanged"
                 disabled="@Disabled">
        <option value="@PrincipalBusinessActivityType.None">-- Select Principal Business Activity --</option>
        @foreach (var activity in GetAllActivities())
        {
            <option value="@activity">@activity.GetDisplayName()</option>
        }
    </InputSelect>
</div>

@code {
    [CascadingParameter]
    private EditContext? EditContext { get; set; }
    /// <summary>
    /// Gets or sets the input element ID for accessibility.
    /// </summary>
    [Parameter]
    public string Id { get; set; } = "principal-activity";

    /// <summary>
    /// Gets or sets the label text displayed above the dropdown.
    /// </summary>
    [Parameter]
    public string Label { get; set; } = "Principal Business Activity";

    /// <summary>
    /// Gets or sets the currently selected principal business activity.
    /// </summary>
    [Parameter]
    public PrincipalBusinessActivityType Value { get; set; } = PrincipalBusinessActivityType.None;

    /// <summary>
    /// Gets or sets the callback invoked when the selected value changes.
    /// </summary>
    [Parameter]
    public EventCallback<PrincipalBusinessActivityType> ValueChanged { get; set; }

    /// <summary>
    /// Gets or sets the value expression for validation.
    /// </summary>
    [Parameter]
    public Expression<Func<PrincipalBusinessActivityType>>? ValueExpression { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether this field is required.
    /// When true, displays a red asterisk (*) indicator.
    /// </summary>
    [Parameter]
    public bool IsRequired { get; set; } = true;

    /// <summary>
    /// Gets or sets a value indicating whether the dropdown is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; } = false;

    /// <summary>
    /// Gets or sets additional CSS classes to apply to the select element.
    /// </summary>
    [Parameter]
    public string CssClass { get; set; } = string.Empty;

    /// <summary>
    /// Handles the value changed event and invokes the ValueChanged callback.
    /// </summary>
    private async Task OnValueChanged()
    {
        await ValueChanged.InvokeAsync(Value);

        if (EditContext != null && ValueExpression != null)
        {
            var field = FieldIdentifier.Create(ValueExpression);
            EditContext.NotifyFieldChanged(field);
        }
    }

    /// <summary>
    /// Gets all principal business activity options sorted by display name.
    /// Excludes the None option which is shown as the default placeholder.
    /// </summary>
    private IEnumerable<PrincipalBusinessActivityType> GetAllActivities()
    {
        return Enum.GetValues<PrincipalBusinessActivityType>()
            .Where(a => a != PrincipalBusinessActivityType.None)
            .OrderBy(a => a.GetDisplayName());
    }
}
