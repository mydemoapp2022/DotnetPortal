@using UI.EmployerPortal.Razor.SharedComponents.Inputs
@using UI.EmployerPortal.Web.Features.EmployerRegistration.Models
@using UI.EmployerPortal.Web.Features.EmployerRegistration.Components.Shared
@using UI.EmployerPortal.Razor.SharedComponents

<div class="member-based-section">
    @if (Config.RequiresState)
    {
        <StateSelect Id="registration-state"
                     Label="@Config.StateLabel"
                     Value="@RegistrationState"
                     ValueChanged="StateChanged"
                     CssClass="@(GetFieldCssClass("RegistrationState"))" />
    }

    <div class="owner-info-section">
        <h2 class="section-subtitle">Owner Information</h2>

        @for (int i = 0; i < Members.Count; i++)
        {
            var index = i;
            var member = Members[index];

            <div class="member-card">
                <h3 class="member-title">@member.Role</h3>

                <div class="member-fields">
                    <div class="form-group">
                        <label for="first-name-@index" class="form-label">
                            <span class="required-asterisk">*</span> First Name
                        </label>
                        <input type="text"
                               id="first-name-@index"
                               class="form-input @(GetFieldCssClass($"Member{index}_FirstName"))"
                               @bind="member.FirstName"
                               @bind:after="ValidateForm" />
                    </div>

                    <div class="form-group form-field-small">
                        <label for="middle-initial-@index" class="form-label">Middle Initial</label>
                        <input type="text"
                               id="middle-initial-@index"
                               class="form-input"
                               maxlength="1"
                               @bind="member.MiddleInitial"
                               @bind:after="ValidateForm" />
                    </div>

                    <div class="form-group">
                        <label for="last-name-@index" class="form-label">
                            <span class="required-asterisk">*</span> Last Name
                        </label>
                        <input type="text"
                               id="last-name-@index"
                               class="form-input @(GetFieldCssClass($"Member{index}_LastName"))"
                               @bind="member.LastName"
                               @bind:after="ValidateForm" />
                    </div>

                    <SSNInput Id="@($"ssn-{index}")"
                              Label="SSN"
                              Value="@member.SSN"
                              ValueChanged="@((string value) => OnSSNChanged(index, value))"
                              IsFocused="@member.IsSSNFocused"
                              IsFocusedChanged="@((bool focused) => OnSSNFocusChanged(index, focused))"
                              ShowSSN="@ShowSSN"
                              ShowSSNChanged="@((bool show) => ShowSSN = show)"
                              IsRequired="@(!IsOutsideUSA)"
                              CssClass="@(GetFieldCssClass($"Member{index}_SSN"))" />

                    <div class="form-group">
                        <label for="ownership-percentage-@index" class="form-label">Ownership Percentage</label>
                        <input type="number"
                               id="ownership-percentage-@index"
                               class="form-input"
                               min="0"
                               max="100"
                               @bind="member.OwnershipPercentage"
                               @bind:after="ValidateForm" />
                    </div>
                </div>
            </div>
        }

        <div class="more-than-five-group @(GetFieldCssClass("MoreThanFive"))">
            <label class="more-label">
                <span class="required-asterisk">*</span> More than five?
            </label>
            <label class="radio-label">
                <input type="radio"
                       name="more-than-five"
                       value="true"
                       checked="@(MoreThanFive == true)"
                       @onchange="() => OnMoreThanFiveChanged(true)" />
                <span>Yes</span>
            </label>
            <label class="radio-label">
                <input type="radio"
                       name="more-than-five"
                       value="false"
                       checked="@(MoreThanFive == false)"
                       @onchange="() => OnMoreThanFiveChanged(false)" />
                <span>No</span>
            </label>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public OwnershipFormConfig Config { get; set; } = new();

    [Parameter]
    public EventCallback<MemberBasedFormData> OnDataChanged { get; set; }

    [Parameter]
    public EventCallback<List<string>> OnValidationChanged { get; set; }

    [Parameter]
    public bool ShouldValidate { get; set; }

    [Parameter]
    public bool IsOutsideUSA { get; set; }

    [Parameter]
    public object? SavedData { get; set; }

    private string RegistrationState { get; set; } = string.Empty;
    private bool ShowSSN { get; set; }
    private bool? MoreThanFive { get; set; } = false;
    private List<OwnerMember> Members { get; set; } = [];
    private List<string> ValidationErrors { get; set; } = [];
    private HashSet<string> InvalidFields { get; set; } = [];
    private bool _lastShouldValidate;
    private bool _dataRestored;
    private bool _previousIsOutsideUSA;

    protected override void OnInitialized()
    {
        _previousIsOutsideUSA = IsOutsideUSA;
        InitializeMembers();
        RestoreFromSession();
        ValidateForm();
    }

    protected override void OnParametersSet()
    {
        if (_previousIsOutsideUSA != IsOutsideUSA)
        {
            _previousIsOutsideUSA = IsOutsideUSA;
            ValidateForm();
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);

        if (ShouldValidate && !_lastShouldValidate)
        {
            _lastShouldValidate = true;
            ValidateForm();
        }
        else if (!ShouldValidate)
        {
            _lastShouldValidate = false;
        }
    }

    private void RestoreFromSession()
    {
        if (_dataRestored || SavedData == null)
        {
            return;
        }

        try
        {
            if (SavedData is OwnershipSessionData sessionData)
            {
                RegistrationState = sessionData.RegistrationState ?? string.Empty;
                MoreThanFive = sessionData.MoreThanFive;

                if (sessionData.Members is { Count: > 0 })
                {
                    Members.Clear();
                    foreach (var savedMember in sessionData.Members)
                    {
                        Members.Add(new OwnerMember
                        {
                            Role = savedMember.Role,
                            FirstName = savedMember.FirstName,
                            MiddleInitial = savedMember.MiddleInitial,
                            LastName = savedMember.LastName,
                            SSN = savedMember.SSN,
                            OwnershipPercentage = savedMember.OwnershipPercentage
                        });
                    }
                }

                _dataRestored = true;
            }
        }
        catch
        {
            // Failed to restore, continue with defaults
        }
    }

    private void InitializeMembers()
    {
        if (Members.Count > 0)
        {
            return;
        }

        Members.Clear();
        for (var i = 1; i <= Config.MaxEntries; i++)
        {
            Members.Add(new OwnerMember { Role = $"{Config.MemberLabel} {i}" });
        }
    }

    private void StateChanged(string value)
    {
        RegistrationState = value;
        ValidateForm();
    }

    private void OnSSNChanged(int index, string value)
    {
        if (index >= 0 && index < Members.Count)
        {
            Members[index].SSN = value;
            ValidateForm();
        }
    }

    private void OnSSNFocusChanged(int index, bool focused)
    {
        if (index >= 0 && index < Members.Count)
        {
            Members[index].IsSSNFocused = focused;
        }
    }

    private void OnMoreThanFiveChanged(bool value)
    {
        MoreThanFive = value;
        ValidateForm();
    }

    private void ValidateForm()
    {
        ValidationErrors.Clear();
        InvalidFields.Clear();

        if (Config.RequiresState && string.IsNullOrWhiteSpace(RegistrationState))
        {
            ValidationErrors.Add($"{Config.StateLabel} is required");
            InvalidFields.Add("RegistrationState");
        }

        for (var i = 0; i < Members.Count; i++)
        {
            var member = Members[i];
            var memberNumber = i + 1;

            var hasAnyValue = !string.IsNullOrWhiteSpace(member.FirstName) ||
                             !string.IsNullOrWhiteSpace(member.MiddleInitial) ||
                             !string.IsNullOrWhiteSpace(member.LastName) ||
                             !string.IsNullOrWhiteSpace(member.SSN) ||
                             member.OwnershipPercentage.HasValue;

            if (i == 0 || hasAnyValue)
            {
                if (string.IsNullOrWhiteSpace(member.FirstName))
                {
                    ValidationErrors.Add($"{Config.MemberLabel} {memberNumber} First Name is required");
                    InvalidFields.Add($"Member{i}_FirstName");
                }

                if (string.IsNullOrWhiteSpace(member.LastName))
                {
                    ValidationErrors.Add($"{Config.MemberLabel} {memberNumber} Last Name is required");
                    InvalidFields.Add($"Member{i}_LastName");
                }

                if (!IsOutsideUSA || !string.IsNullOrWhiteSpace(member.SSN))
                {
                    var ssnResult = SSNInput.ValidateSSN(member.SSN, $"{Config.MemberLabel} {memberNumber}");
                    if (ssnResult != null && !ssnResult.IsValid)
                    {
                        ValidationErrors.Add(ssnResult.ErrorMessage ?? "SSN Required");
                        InvalidFields.Add($"Member{i}_SSN");
                    }
                }
            }
        }

        // Always enforce no-duplicate rule even when SSN is optional
        var ssnList = Members.Select(m => (string?)m.SSN).ToList();
        var duplicateErrors = SSNInput.FindDuplicateSSNs(ssnList, i => $"{Config.MemberLabel} {i + 1}");

        if (duplicateErrors != null && duplicateErrors.Count > 0)
        {
            ValidationErrors.AddRange(duplicateErrors);

            var ssnGroups = Members
                .Select((m, idx) => new { SSN = m.SSN, Index = idx })
                .Where(x => !string.IsNullOrWhiteSpace(x.SSN))
                .GroupBy(x => new string(x.SSN!.Where(char.IsDigit).ToArray()))
                .Where(g => g.Count() > 1);

            foreach (var group in ssnGroups)
            {
                foreach (var item in group)
                {
                    InvalidFields.Add($"Member{item.Index}_SSN");
                }
            }
        }

        if (MoreThanFive == null)
        {
            ValidationErrors.Add("More than five? selection is required");
            InvalidFields.Add("MoreThanFive");
        }

        _ = OnValidationChanged.InvokeAsync(ValidationErrors);
        NotifyDataChanged();

        StateHasChanged();
    }

    private void NotifyDataChanged()
    {
        var formData = new MemberBasedFormData
        {
            RegistrationState = RegistrationState,
            Members = Members.Select(m => new OwnerMember
            {
                Role = m.Role,
                FirstName = m.FirstName,
                MiddleInitial = m.MiddleInitial,
                LastName = m.LastName,
                SSN = m.SSN,
                OwnershipPercentage = m.OwnershipPercentage
            }).ToList(),
            MoreThanFive = MoreThanFive
        };

        _ = OnDataChanged.InvokeAsync(formData);
    }

    private string GetFieldCssClass(string fieldName)
    {
        return InvalidFields.Contains(fieldName) ? "input-validation-error" : string.Empty;
    }
}
