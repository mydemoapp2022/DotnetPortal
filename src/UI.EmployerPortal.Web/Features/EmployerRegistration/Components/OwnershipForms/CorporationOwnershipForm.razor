@using UI.EmployerPortal.Razor.SharedComponents.Inputs
@using UI.EmployerPortal.Web.Features.EmployerRegistration.Models
@using UI.EmployerPortal.Web.Features.EmployerRegistration.Components.Shared

<div class="corporation-section">
    <!-- Incorporation State or Foreign Country -->
    <div class="form-row">
        <StateSelect Id="incorporation-state"
                     Label="@Config.StateLabel"
                     Value="@IncorporationState"
                     ValueChanged="OnIncorporationStateChanged"
                     Disabled="@(!string.IsNullOrWhiteSpace(ForeignCountry))"
                     CssClass="@(GetFieldCssClass("IncorporationState"))" />

        <div class="form-group-divider">
            <span>OR</span>
        </div>

        <div class="form-group state-selection">
            <label for="foreign-country" class="form-label">
                <span class="required-asterisk">*</span> Foreign Country
            </label>
            <input type="text"
                   id="foreign-country"
                   class="form-input @(GetFieldCssClass("ForeignCountry"))"
                   @bind="ForeignCountry"
                   @bind:after="OnForeignCountryChanged"
                   disabled="@(!string.IsNullOrWhiteSpace(IncorporationState))" />
        </div>
    </div>

    <!-- Owner Information Section -->
    <div class="owner-info-section">
        <h2 class="section-subtitle">Owner Information</h2>

        @for (var i = 0; i < Officers.Count; i++)
        {
            var index = i;
            var officer = Officers[index];

            <div class="member-card">
                <h3 class="member-title">@officer.Role</h3>

                <div class="member-fields">
                    <div class="form-group">
                        <label for="first-name-@officer.Role" class="form-label">
                            <span class="required-asterisk">*</span> First Name
                        </label>
                        <input type="text"
                               id="first-name-@officer.Role"
                               class="form-input @(GetFieldCssClass($"{officer.Role}_FirstName"))"
                               @bind="officer.FirstName"
                               @bind:after="ValidateForm" />
                    </div>

                    <div class="form-group">
                        <label for="middle-initial-@officer.Role" class="form-label">Middle Initial</label>
                        <input type="text"
                               id="middle-initial-@officer.Role"
                               class="form-input"
                               maxlength="1"
                               @bind="officer.MiddleInitial"
                               @bind:after="ValidateForm" />
                    </div>

                    <div class="form-group">
                        <label for="last-name-@officer.Role" class="form-label">
                            <span class="required-asterisk">*</span> Last Name
                        </label>
                        <input type="text"
                               id="last-name-@officer.Role"
                               class="form-input @(GetFieldCssClass($"{officer.Role}_LastName"))"
                               @bind="officer.LastName"
                               @bind:after="ValidateForm" />
                    </div>

                    <SSNInput Id="@($"ssn-{officer.Role}")"
                              Label="SSN"
                              @ref="ssnInput"
                              Value="@officer.SSN"
                              ValueChanged="@((string value) => OnSSNChanged(index, value))"
                              IsFocused="@officer.IsSSNFocused"
                              IsFocusedChanged="@((bool focused) => OnSSNFocusChanged(index, focused))"
                              ShowSSN="@ShowSSN"
                              ShowSSNChanged="@((bool show) => ShowSSN = show)"
                              CssClass="@(GetFieldCssClass($"{officer.Role}_SSN"))" />

                    <div class="form-group">
                        <label for="ownership-percentage-@officer.Role" class="form-label">Ownership Percentage</label>
                        <input type="number"
                               id="ownership-percentage-@officer.Role"
                               class="form-input"
                               min="0"
                               max="100"
                               @bind="officer.OwnershipPercentage"
                               @bind:after="ValidateForm" />
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public OwnershipFormConfig Config { get; set; } = new();

    [Parameter]
    public EventCallback<CorporationFormData> OnDataChanged { get; set; }

    [Parameter]
    public EventCallback<List<string>> OnValidationChanged { get; set; }

    [Parameter]
    public bool ShouldValidate { get; set; }

    [Parameter]
    public object? SavedData { get; set; }

    private string IncorporationState { get; set; } = string.Empty;
    private string ForeignCountry { get; set; } = string.Empty;
    private bool ShowSSN { get; set; }
    private List<OwnerMember> Officers { get; set; } = [];
    private List<string> ValidationErrors { get; set; } = [];
    private HashSet<string> InvalidFields { get; set; } = [];
    private bool _lastShouldValidate;
    private bool _dataRestored;
    private SSNInput? ssnInput;

    protected override void OnInitialized()
    {
        InitializeOfficers();
        RestoreFromSession();
        ValidateForm();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);

        if (ShouldValidate && !_lastShouldValidate)
        {
            _lastShouldValidate = true;
            ValidateForm();
        }
        else if (!ShouldValidate)
        {
            _lastShouldValidate = false;
        }
    }

    private void RestoreFromSession()
    {
        if (_dataRestored || SavedData == null)
        {
            return;
        }

        try
        {
            if (SavedData is OwnershipSessionData sessionData)
            {
                IncorporationState = sessionData.IncorporationState ?? string.Empty;
                ForeignCountry = sessionData.ForeignCountry ?? string.Empty;

                if (sessionData.Officers is { Count: > 0 })
                {
                    Officers.Clear();
                    foreach (var savedOfficer in sessionData.Officers)
                    {
                        Officers.Add(new OwnerMember
                        {
                            Role = savedOfficer.Role,
                            FirstName = savedOfficer.FirstName,
                            MiddleInitial = savedOfficer.MiddleInitial,
                            LastName = savedOfficer.LastName,
                            SSN = savedOfficer.SSN,
                            OwnershipPercentage = savedOfficer.OwnershipPercentage
                        });
                    }
                }

                _dataRestored = true;
            }
        }
        catch
        {
            // Failed to restore, continue with defaults
        }
    }

    private void InitializeOfficers()
    {
        if (Officers.Count > 0)
        {
            return;
        }

        Officers.Clear();
        foreach (var role in Config.PredefinedRoles)
        {
            Officers.Add(new OwnerMember { Role = role });
        }
    }

    private void OnIncorporationStateChanged(string value)
    {
        IncorporationState = value;
        if (!string.IsNullOrWhiteSpace(IncorporationState))
        {
            ForeignCountry = string.Empty;
        }
        ValidateForm();
    }

    private void OnForeignCountryChanged()
    {
        if (!string.IsNullOrWhiteSpace(ForeignCountry))
        {
            IncorporationState = string.Empty;
        }
        ValidateForm();
    }

    private void OnSSNChanged(int index, string value)
    {
        if (index >= 0 && index < Officers.Count)
        {
            Officers[index].SSN = value;
            ValidateForm();
        }
    }

    private void OnSSNFocusChanged(int index, bool focused)
    {
        if (index >= 0 && index < Officers.Count)
        {
            Officers[index].IsSSNFocused = focused;
        }
    }

    private void ValidateForm()
    {
        ValidationErrors.Clear();
        InvalidFields.Clear();

        // Validate Incorporation State or Foreign Country
        if (string.IsNullOrWhiteSpace(IncorporationState) && string.IsNullOrWhiteSpace(ForeignCountry))
        {
            ValidationErrors.Add($"{Config.StateLabel} or Foreign Country is required");
            InvalidFields.Add("IncorporationState");
            InvalidFields.Add("ForeignCountry");
        }

        // Check if at least one officer has any data entered
        var hasAnyOfficerData = Officers.Any(o =>
            !string.IsNullOrWhiteSpace(o.FirstName) ||
            !string.IsNullOrWhiteSpace(o.MiddleInitial) ||
            !string.IsNullOrWhiteSpace(o.LastName) ||
            !string.IsNullOrWhiteSpace(o.SSN) ||
            o.OwnershipPercentage.HasValue);

        if (!hasAnyOfficerData)
        {
            ValidationErrors.Add("At least one officer is required");
        }
        else
        {
            // Validate each officer that has any data
            for (var i = 0; i < Officers.Count; i++)
            {
                var officer = Officers[i];
                var hasAnyValue = !string.IsNullOrWhiteSpace(officer.FirstName) ||
                                 !string.IsNullOrWhiteSpace(officer.MiddleInitial) ||
                                 !string.IsNullOrWhiteSpace(officer.LastName) ||
                                 !string.IsNullOrWhiteSpace(officer.SSN) ||
                                 officer.OwnershipPercentage.HasValue;

                if (hasAnyValue)
                {
                    if (string.IsNullOrWhiteSpace(officer.FirstName))
                    {
                        ValidationErrors.Add($"{officer.Role} First Name is required");
                        InvalidFields.Add($"{officer.Role}_FirstName");
                    }

                    if (string.IsNullOrWhiteSpace(officer.LastName))
                    {
                        ValidationErrors.Add($"{officer.Role} Last Name is required");
                        InvalidFields.Add($"{officer.Role}_LastName");
                    }

                    var ssnResult = ssnInput?.ValidateSSN(officer.SSN, officer.Role);
                    if (ssnResult != null && !ssnResult.IsValid)
                    {
                        ValidationErrors.Add(ssnResult.ErrorMessage ?? "SSN Required");
                        InvalidFields.Add($"{officer.Role}_SSN");
                    }
                }
            }

            // Check for duplicate SSNs
            var ssnList = Officers.Select(o => (string?)o.SSN).ToList();
            var duplicateErrors = ssnInput?.FindDuplicateSSNs(ssnList, i => Officers[i].Role);

            if (duplicateErrors != null && duplicateErrors.Count > 0)
            {
                ValidationErrors.AddRange(duplicateErrors);

                var ssnGroups = Officers
                    .Select((o, idx) => new { SSN = o.SSN, Role = o.Role, Index = idx })
                    .Where(x => !string.IsNullOrWhiteSpace(x.SSN))
                    .GroupBy(x =>
                    {
                        return new string(x.SSN!.Where(char.IsDigit).ToArray());
                    })
                    .Where(g => g.Count() > 1);

                foreach (var group in ssnGroups)
                {
                    foreach (var item in group)
                    {
                        InvalidFields.Add($"{item.Role}_SSN");
                    }
                }
            }
        }

        _ = OnValidationChanged.InvokeAsync(ValidationErrors);
        NotifyDataChanged();

        StateHasChanged();
    }

    private void NotifyDataChanged()
    {
        var formData = new CorporationFormData
        {
            IncorporationState = IncorporationState,
            ForeignCountry = ForeignCountry,
            Officers = Officers.Select(o => new OwnerMember
            {
                Role = o.Role,
                FirstName = o.FirstName,
                MiddleInitial = o.MiddleInitial,
                LastName = o.LastName,
                SSN = o.SSN,
                OwnershipPercentage = o.OwnershipPercentage
            }).ToList()
        };

        _ = OnDataChanged.InvokeAsync(formData);
    }

    private string GetFieldCssClass(string fieldName)
    {
        return InvalidFields.Contains(fieldName) ? "input-validation-error" : string.Empty;
    }
}
